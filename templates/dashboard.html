{% extends "base.html" %} {% block title %}Dashboard - {{ user.username }}{%
endblock %} {% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Welcome, {{ user.username }}!</h2>
    {% if user.is_admin %}
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary"
      >Admin Dashboard</a
    >
    {% endif %}
  </div>

  <div class="card mb-4">
    <div class="card-body text-center">
      <h5 class="card-title">Manage Your RStudio Access</h5>
      <p class="card-text">
        Request a new RStudio instance or manage your existing ones below.
      </p>
      <div class="mb-3">
        <div class="d-inline-flex align-items-center justify-content-center mb-3 badge bg-light text-dark rounded-pill px-3 py-2 me-2">
          <i class="bi bi-memory me-1"></i> Memory: {{ memory_limit }}
        </div>
        <div class="d-inline-flex align-items-center justify-content-center mb-3 badge bg-light text-dark rounded-pill px-3 py-2 me-2">
          <i class="bi bi-cpu me-1"></i> CPUs: {{ cpu_limit }}
        </div>
        <div class="d-inline-flex align-items-center justify-content-center mb-3 badge bg-light text-dark rounded-pill px-3 py-2">
          <i class="bi bi-hdd me-1"></i> Storage: {{ storage_limit }}
        </div>
      </div>
      <form
        action="{{ url_for('request_rstudio_instance') }}"
        method="post"
        onsubmit="showLoading(this, 'Requesting Instance...')"
      >
        <button type="submit" class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle-fill me-2"></i>Request New RStudio
          Instance
        </button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Your RStudio Instances</h3>
    </div>
    <div class="card-body">
      {% if instances %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Container Name</th>
              <th>Port</th>
              <th>Status</th>
              <th>Created At</th>
              <th>Expires At</th>
              <th>Stopped At</th>
              {# New column header #}
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for instance in instances %}
            <tr>
              <td>{{ instance.container_name }}</td>
              <td>{{ instance.port }}</td>
              <td>
                <span
                  class="badge rounded-pill {% if instance.status == 'running' %}bg-success {% elif instance.status == 'requested' %}bg-warning text-dark {% elif instance.status == 'stopped' %}bg-secondary {% elif instance.status == 'error' %}bg-danger {% else %}bg-light text-dark {% endif %}"
                  style="font-size: 0.9em"
                >
                  {{ instance.status | capitalize }}
                </span>
              </td>
              <td>
                {{ instance.created_at if instance.created_at else 'N/A' }}
              </td>
              <td>
                {{ instance.expires_at if instance.expires_at else 'N/A' }}
              </td>
              <td>
                {{ instance.stopped_at if instance.stopped_at else 'N/A' }} UTC
              </td>
              {# Display stopped_at #}
              <td class="text-center">
                {% if instance.status == 'running' %}
                <a
                  href="http://{{ request.url.hostname }}:{{ instance.port }}"
                  target="_blank"
                  class="btn btn-success btn-sm me-1"
                  title="Access RStudio"
                >
                  <i class="bi bi-box-arrow-up-right"></i> Access
                </a>
                <form
                  action="{{ url_for('stop_rstudio_instance', instance_id=instance.id) }}"
                  method="post"
                  style="display: inline"
                  onsubmit="showLoading(this, 'Stopping Instance...')"
                >
                  <button
                    type="submit"
                    class="btn btn-danger btn-sm"
                    title="Stop Instance"
                  >
                    <i class="bi bi-stop-circle"></i> Stop
                  </button>
                </form>
                <button type="button" class="btn btn-info btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#credentials-{{ instance.id }}">
                  <i class="bi bi-key"></i> View Login Info
                </button>

                <!-- Modal for credentials -->
                <div class="modal fade" id="credentials-{{ instance.id }}" tabindex="-1" aria-labelledby="credentialsModalLabel-{{ instance.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="credentialsModalLabel-{{ instance.id }}">RStudio Login Credentials</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="alert alert-info">
                          <p class="mb-0">Use these credentials to log in when prompted by RStudio:</p>
                        </div>
                        <div class="card">
                          <div class="card-body">
                            <p><strong>Username:</strong> {% if '@' in user.username %}{{ user.username.split('@')[0] }}{% else %}{{ user.username }}{% endif %}</p>
                            <p><strong>Password:</strong> {{ instance.password }}</p>
                            <hr>
                            <div class="mb-0">
                              <strong>Resources:</strong>
                              <ul class="list-unstyled mt-1">
                                <li><i class="bi bi-memory me-1"></i> Memory: {{ memory_limit }}</li>
                                <li><i class="bi bi-cpu me-1"></i> CPUs: {{ cpu_limit }}</li>
                                <li><i class="bi bi-hdd me-1"></i> Storage: {{ storage_limit }}</li>
                              </ul>
                            </div>
                            <p><small class="text-muted">Note: For email addresses, only the part before @ is used as username.</small></p>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% elif instance.status == 'requested' %}
                <span class="text-muted fst-italic">Processing...</span>
                <div
                  class="spinner-border spinner-border-sm text-secondary ms-2"
                  role="status"
                >
                  <span class="visually-hidden">Loading...</span>
                </div>
                {% elif instance.status == 'stopped' or instance.status ==
                'expired' or instance.status == 'error' %} {# Delete button
                removed for non-admin dashboard #} {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-info-circle display-4 text-muted mb-3"></i>
        <p class="lead">You have no RStudio instances.</p>
        <p>
          Click the "Request New RStudio Instance" button above to get started.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{# Global loading overlay spinner #}
<div
  id="global-loading-overlay"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 2000;
    background: rgba(255, 255, 255, 0.7);
    align-items: center;
    justify-content: center;
  "
>
  <div class="text-center">
    <div
      class="spinner-border text-primary"
      style="width: 4rem; height: 4rem"
      role="status"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 fw-bold">Processing...</div>
  </div>
</div>

{% block scripts %}
<script>
  function showLoading(form, message) {
    // Show global overlay
    var overlay = document.getElementById("global-loading-overlay");
    if (overlay) {
      overlay.style.display = "flex";
      overlay.querySelector(".fw-bold").textContent =
        message || "Processing...";
    }
    // Disable all submit buttons in the form
    const submitButtons = form.querySelectorAll('button[type="submit"]');
    submitButtons.forEach((button) => {
      button.disabled = true;
      button.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        ${message || "Processing..."}
      `;
    });
    // Allow form submission to proceed
    return true;
  }
  // Hide overlay on page load (in case of back navigation)
  window.addEventListener("pageshow", function () {
    var overlay = document.getElementById("global-loading-overlay");
    if (overlay) overlay.style.display = "none";
  });
</script>
{% endblock %} {% endblock %}
