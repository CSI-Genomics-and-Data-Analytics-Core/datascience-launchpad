{% extends "base.html" %} {% block title %}Dashboard - {{ user.username }}{%
endblock %} {% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Welcome, {{ user.username }}!</h2>
    {% if user.is_admin %}
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary"
      >Admin Dashboard</a
    >
    {% endif %}
  </div>

  {% if request.query_params.get("message") %}
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    {{ request.query_params.get("message") }}
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  {% endif %} {% if request.query_params.get("error") %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ request.query_params.get("error") }}
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-body text-center">
      <h5 class="card-title">Manage Your RStudio Access</h5>
      <p class="card-text">
        Request a new RStudio instance or manage your existing ones below.
      </p>
      <form action="{{ url_for('request_rstudio_instance') }}" method="post">
        <button type="submit" class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle-fill me-2"></i>Request New RStudio
          Instance
        </button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Your RStudio Instances</h3>
    </div>
    <div class="card-body">
      {% if instances %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Container Name</th>
              <th>Port</th>
              <th>Status</th>
              <th>Created At</th>
              <th>Expires At</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for instance in instances %}
            <tr>
              <td>{{ instance.container_name }}</td>
              <td>{{ instance.port }}</td>
              <td>
                <span
                  class="badge rounded-pill {% if instance.status == 'running' %}bg-success {% elif instance.status == 'requested' %}bg-warning text-dark {% elif instance.status == 'stopped' %}bg-secondary {% elif instance.status == 'error' %}bg-danger {% else %}bg-light text-dark {% endif %}"
                  style="font-size: 0.9em"
                >
                  {{ instance.status | capitalize }}
                </span>
              </td>
              <td>
                {{ instance.created_at if instance.created_at else 'N/A' }}
              </td>
              <td>
                {{ instance.expires_at if instance.expires_at else 'N/A' }}
              </td>
              <td class="text-center">
                {% if instance.status == 'running' %}
                <a
                  href="http://{{ request.url.hostname }}:{{ instance.port }}"
                  target="_blank"
                  class="btn btn-success btn-sm me-1"
                  title="Access RStudio"
                >
                  <i class="bi bi-box-arrow-up-right"></i> Access
                </a>
                <form
                  action="{{ url_for('stop_rstudio_instance', instance_id=instance.id) }}"
                  method="post"
                  style="display: inline"
                >
                  <button
                    type="submit"
                    class="btn btn-danger btn-sm"
                    title="Stop Instance"
                  >
                    <i class="bi bi-stop-circle"></i> Stop
                  </button>
                </form>
                {% elif instance.status == 'requested' %}
                <span class="text-muted fst-italic">Processing...</span>
                <div
                  class="spinner-border spinner-border-sm text-secondary ms-2"
                  role="status"
                >
                  <span class="visually-hidden">Loading...</span>
                </div>
                {% elif instance.status == 'stopped' or instance.status ==
                'expired' or instance.status == 'error' %}
                <form
                  action="{{ url_for('delete_rstudio_instance', instance_id=instance.id) }}"
                  method="post"
                  style="display: inline"
                >
                  <button
                    type="submit"
                    class="btn btn-warning btn-sm"
                    title="Delete Instance Record"
                  >
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </form>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-info-circle display-4 text-muted mb-3"></i>
        <p class="lead">You have no RStudio instances.</p>
        <p>
          Click the "Request New RStudio Instance" button above to get started.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
